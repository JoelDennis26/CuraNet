<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Details - CuraNet</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --text-primary: #ffffff;
            --text-secondary: #a1a1a1;
            --border-color: #2a2a2a;
            --primary-color: #2196f3;
            --success-color: #4caf50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .back-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .patient-header {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 30px;
            margin-bottom: 30px;
        }

        .patient-header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .patient-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 20px;
        }

        .info-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .info-item {
            margin-bottom: 10px;
        }

        .info-item label {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .info-item span {
            color: var(--text-primary);
        }

        .medical-history {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 20px;
        }

        .history-item {
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 15px;
        }

        .history-date {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
        }

        /* File Sharing Styles */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .upload-area:hover, .upload-area.drag-over {
            border-color: var(--primary-color);
            background: var(--bg-primary);
        }

        .upload-content svg {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .upload-link {
            color: var(--primary-color);
            text-decoration: underline;
            cursor: pointer;
        }

        .upload-hint {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            background: var(--bg-primary);
        }

        .report-info h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
        }

        .report-info p {
            margin: 0.25rem 0;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .btn-download {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .btn-download:hover {
            background: #1976d2;
        }

        .success-message {
            color: var(--success-color);
            padding: 1rem;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 6px;
            margin-top: 1rem;
        }

        .error-message {
            color: #f44336;
            padding: 1rem;
            background: rgba(244, 67, 54, 0.1);
            border-radius: 6px;
            margin-top: 1rem;
        }

        .loading {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="doctor-patients.html" class="back-btn">‚Üê Back to Patients</a>
        
        <div class="patient-header">
            <h1 id="patientName">Loading...</h1>
            <p>Patient ID: <span id="patientId">--</span></p>
        </div>

        <div class="patient-info">
            <div class="info-card">
                <h3>Personal Information</h3>
                <div class="info-item">
                    <label>Age:</label> <span id="patientAge">--</span>
                </div>
                <div class="info-item">
                    <label>Blood Group:</label> <span id="bloodGroup">--</span>
                </div>
                <div class="info-item">
                    <label>Email:</label> <span id="patientEmail">--</span>
                </div>
                <div class="info-item">
                    <label>Phone:</label> <span id="patientPhone">--</span>
                </div>
            </div>

            <div class="info-card">
                <h3>Medical Information</h3>
                <div class="info-item">
                    <label>Medical History:</label>
                    <p id="medicalHistory">--</p>
                </div>
                <div class="info-item">
                    <label>Last Visit:</label> <span id="lastVisit">--</span>
                </div>
                <div class="info-item">
                    <label>Total Visits:</label> <span id="totalVisits">--</span>
                </div>
            </div>
        </div>

        <div class="medical-history">
            <h3>Recent Medical Sessions</h3>
            <div id="recentSessions">
                <p>Loading recent sessions...</p>
            </div>
            <button class="btn-primary" onclick="startNewSession()">Start New Session</button>
        </div>

        <!-- File Sharing Section -->
        <div class="info-card" style="margin-top: 30px;">
            <h3>üìÅ Medical Reports & Files</h3>
            
            <!-- Upload Section -->
            <div class="upload-section" style="margin-bottom: 20px;">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        <p>Drag files here or <span class="upload-link">browse</span></p>
                        <p class="upload-hint">PDF, DOC, DOCX, JPG, PNG (Max 10MB)</p>
                    </div>
                    <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;">
                </div>
                <div class="upload-progress" id="uploadProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="progressText">Uploading...</p>
                </div>
                <div class="upload-result" id="uploadResult"></div>
            </div>

            <!-- Reports List -->
            <div class="reports-list" id="reportsList">
                <div class="loading">Loading reports...</div>
            </div>
        </div>
    </div>

    <script>
        let currentPatientId = null;

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentPatientId = urlParams.get('id');
            
            if (currentPatientId) {
                loadPatientDetails();
                setupFileSharing();
            } else {
                alert('No patient ID provided');
                window.location.href = 'doctor-patients.html';
            }
        });

        async function loadPatientDetails() {
            try {
                const response = await fetch(`/api/patient/${currentPatientId}`);
                if (response.ok) {
                    const patient = await response.json();
                    
                    document.getElementById('patientName').textContent = patient.name;
                    document.getElementById('patientId').textContent = `P${patient.id}`;
                    document.getElementById('patientAge').textContent = patient.age;
                    document.getElementById('bloodGroup').textContent = patient.blood_group;
                    document.getElementById('patientEmail').textContent = patient.email;
                    document.getElementById('patientPhone').textContent = patient.phone;
                    document.getElementById('medicalHistory').textContent = patient.medical_history || 'No medical history recorded';
                    
                    // Load recent sessions
                    loadRecentSessions();
                } else {
                    throw new Error('Failed to load patient details');
                }
            } catch (error) {
                console.error('Error loading patient details:', error);
                alert('Failed to load patient details');
            }
        }

        async function loadRecentSessions() {
            try {
                const response = await fetch(`/patient/${currentPatientId}/medical-history`);
                if (response.ok) {
                    const sessions = await response.json();
                    const container = document.getElementById('recentSessions');
                    
                    if (sessions.length === 0) {
                        container.innerHTML = '<p>No previous medical sessions found.</p>';
                        return;
                    }
                    
                    container.innerHTML = sessions.slice(0, 5).map(session => `
                        <div class="history-item">
                            <div class="history-date">${new Date(session.session_date).toLocaleDateString()}</div>
                            <p><strong>Doctor:</strong> ${session.doctor_name}</p>
                            <p><strong>Chief Complaint:</strong> ${session.chief_complaint || 'Not recorded'}</p>
                            <p><strong>Status:</strong> ${session.status}</p>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('recentSessions').innerHTML = '<p>Unable to load medical history.</p>';
                }
            } catch (error) {
                console.error('Error loading recent sessions:', error);
                document.getElementById('recentSessions').innerHTML = '<p>Error loading medical history.</p>';
            }
        }

        function startNewSession() {
            // This would create a new appointment and start a session
            alert('New session functionality coming soon!');
        }

        // File Sharing Functionality
        let currentDoctorId = 1; // Get from session/auth

        document.addEventListener('DOMContentLoaded', () => {
            setupFileSharing();
        });

        function setupFileSharing() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadLink = document.querySelector('.upload-link');

            // Click to browse
            uploadLink.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('click', () => fileInput.click());

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            // Load existing reports
            loadPatientReports();
        }

        async function handleFileUpload(file) {
            const progressDiv = document.getElementById('uploadProgress');
            const resultDiv = document.getElementById('uploadResult');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            // Show progress
            progressDiv.style.display = 'block';
            resultDiv.innerHTML = '';

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('patient_id', currentPatientId);
                formData.append('doctor_id', currentDoctorId);
                formData.append('shared_with', JSON.stringify([])); // Share with all doctors

                progressFill.style.width = '30%';
                progressText.textContent = 'Uploading to server...';

                const response = await fetch('/reports/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }

                const result = await response.json();
                
                progressFill.style.width = '100%';
                progressText.textContent = 'Upload complete!';

                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    resultDiv.innerHTML = `
                        <div class="success-message">
                            ‚úÖ File "${file.name}" uploaded successfully!
                        </div>
                    `;
                    
                    // Refresh reports list
                    loadPatientReports();
                }, 1000);

            } catch (error) {
                progressDiv.style.display = 'none';
                resultDiv.innerHTML = `
                    <div class="error-message">
                        ‚ùå Upload failed: ${error.message}
                    </div>
                `;
            }
        }

        async function loadPatientReports() {
            const reportsList = document.getElementById('reportsList');
            
            try {
                const response = await fetch(`/reports/patient/${currentPatientId}?doctor_id=${currentDoctorId}`);
                
                if (!response.ok) {
                    console.warn('Reports endpoint failed, showing empty state');
                    reportsList.innerHTML = '<div class="loading">No reports found (File sharing ready for upload)</div>';
                    return;
                }

                const reports = await response.json();
                
                if (!reports || reports.length === 0) {
                    reportsList.innerHTML = '<div class="loading">No reports found</div>';
                    return;
                }

                reportsList.innerHTML = reports.map(report => `
                    <div class="report-item">
                        <div class="report-info">
                            <h4>${report.report_name}</h4>
                            <p>Uploaded by: ${report.uploaded_by}</p>
                            <p>Date: ${new Date(report.uploaded_at).toLocaleDateString()}</p>
                            <p>Size: ${formatFileSize(report.file_size)}</p>
                        </div>
                        <div class="report-actions">
                            <button class="btn-download" onclick="downloadReport(${report.report_id})">
                                Download
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.warn('Reports loading failed:', error);
                reportsList.innerHTML = '<div class="loading">File sharing ready (Upload files to see them here)</div>';
            }
        }

        async function downloadReport(reportId) {
            try {
                const response = await fetch(`/reports/${reportId}/download?doctor_id=${currentDoctorId}`);
                
                if (!response.ok) {
                    throw new Error(`Download failed: ${response.statusText}`);
                }

                const result = await response.json();
                
                // Check if it's a mock URL
                if (result.download_url.includes('mock-s3-url')) {
                    alert('File download simulated (S3 not configured). In production, this would download the actual file.');
                } else {
                    // Open download URL in new tab
                    window.open(result.download_url, '_blank');
                }
                
            } catch (error) {
                alert(`Download failed: ${error.message}`);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>