<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Session Management - CuraNet</title>
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --text-primary: #ffffff;
            --text-secondary: #a1a1a1;
            --border-color: #2a2a2a;
            --primary-color: #2196f3;
            --success-color: #4caf50;
            --warning-color: #ffc107;
            --danger-color: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .session-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .patient-info h2 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .session-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .session-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .session-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 20px;
        }

        .card-title {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .vital-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .item-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .list-item {
            background: var(--bg-primary);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .list-item strong {
            color: var(--primary-color);
        }

        .session-notes {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .session-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .back-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .session-content {
                grid-template-columns: 1fr;
            }
            
            .vital-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="session-container">
        <a href="doctor-dashboard.html" class="back-btn">← Back to Dashboard</a>
        
        <div class="session-header">
            <div class="patient-info">
                <h2 id="patientName">John Doe</h2>
                <p>Patient ID: <span id="patientId">P001</span> | Session ID: <span id="sessionId">S001</span></p>
                <p>Appointment: <span id="appointmentTime">2025-01-17 10:00 AM</span></p>
            </div>
            <div class="session-status">
                <span class="status-badge" id="sessionStatus">Active</span>
            </div>
        </div>

        <div class="session-tabs">
            <button class="tab-btn active" onclick="showTab('current')">Current Session</button>
            <button class="tab-btn" onclick="showTab('history')">Medical History</button>
        </div>

        <div id="currentTab" class="tab-content">
            <div class="session-content">
                <!-- Vital Signs Card -->
                <div class="session-card">
                    <div class="card-title">
                        Vital Signs
                        <button class="add-btn" onclick="openModal('vitalModal')">+ Add</button>
                    </div>
                    <div class="vital-grid">
                        <div>
                            <label>BP:</label>
                            <span id="bloodPressure">--/--</span>
                        </div>
                        <div>
                            <label>HR:</label>
                            <span id="heartRate">-- bpm</span>
                        </div>
                        <div>
                            <label>Temp:</label>
                            <span id="temperature">-- °F</span>
                        </div>
                        <div>
                            <label>O2 Sat:</label>
                            <span id="oxygenSat">-- %</span>
                        </div>
                    </div>
                </div>

                <!-- Symptoms Card -->
                <div class="session-card">
                    <div class="card-title">
                        Symptoms
                        <button class="add-btn" onclick="openModal('symptomModal')">+ Add</button>
                    </div>
                    <div class="item-list" id="symptomsList">
                        <div class="list-item">No symptoms recorded</div>
                    </div>
                </div>

                <!-- Prescriptions Card -->
                <div class="session-card">
                    <div class="card-title">
                        Prescriptions
                        <button class="add-btn" onclick="openModal('prescriptionModal')">+ Add</button>
                    </div>
                    <div class="item-list" id="prescriptionsList">
                        <div class="list-item">No prescriptions added</div>
                    </div>
                </div>
            </div>

            <!-- Session Notes -->
            <div class="session-card session-notes">
                <div class="card-title">Session Notes & Diagnosis</div>
                <div class="form-group">
                    <label>Chief Complaint</label>
                    <textarea id="chiefComplaint" placeholder="Patient's main concern..."></textarea>
                </div>
                <div class="form-group">
                    <label>Diagnosis</label>
                    <textarea id="diagnosis" placeholder="Primary and secondary diagnoses..."></textarea>
                </div>
                <div class="form-group">
                    <label>Treatment Plan</label>
                    <textarea id="treatmentPlan" placeholder="Recommended treatment and follow-up..."></textarea>
                </div>
                <div class="form-group">
                    <label>Session Notes</label>
                    <textarea id="sessionNotes" placeholder="Additional notes and observations..."></textarea>
                </div>
            </div>

            <div class="session-actions">
                <button class="btn btn-secondary" onclick="saveSession()">Save Session</button>
                <button class="btn btn-primary" onclick="scheduleFollowUp()">Schedule Follow-up</button>
                <button class="btn btn-success" onclick="completeSession()">Complete Visit</button>
            </div>
        </div>

        <div id="historyTab" class="tab-content" style="display: none;">
            <div class="session-card">
                <div class="card-title">Previous Medical Sessions</div>
                <div id="medicalHistory">
                    <p>Loading medical history...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Vital Signs Modal -->
    <div class="modal" id="vitalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Vital Signs</h3>
                <button class="close-modal" onclick="closeModal('vitalModal')">&times;</button>
            </div>
            <form id="vitalForm">
                <div class="vital-grid">
                    <div class="form-group">
                        <label>Systolic BP</label>
                        <input type="number" id="systolic" placeholder="120">
                    </div>
                    <div class="form-group">
                        <label>Diastolic BP</label>
                        <input type="number" id="diastolic" placeholder="80">
                    </div>
                    <div class="form-group">
                        <label>Heart Rate</label>
                        <input type="number" id="heartRateInput" placeholder="72">
                    </div>
                    <div class="form-group">
                        <label>Temperature (°F)</label>
                        <input type="number" step="0.1" id="temperatureInput" placeholder="98.6">
                    </div>
                    <div class="form-group">
                        <label>Respiratory Rate</label>
                        <input type="number" id="respiratoryRate" placeholder="16">
                    </div>
                    <div class="form-group">
                        <label>O2 Saturation (%)</label>
                        <input type="number" id="oxygenSatInput" placeholder="98">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Add Vital Signs</button>
            </form>
        </div>
    </div>

    <!-- Symptom Modal -->
    <div class="modal" id="symptomModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Symptom</h3>
                <button class="close-modal" onclick="closeModal('symptomModal')">&times;</button>
            </div>
            <form id="symptomForm">
                <div class="form-group">
                    <label>Symptom Description</label>
                    <textarea id="symptomDescription" placeholder="Describe the symptom..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Severity</label>
                    <select id="symptomSeverity" required>
                        <option value="">Select severity</option>
                        <option value="mild">Mild</option>
                        <option value="moderate">Moderate</option>
                        <option value="severe">Severe</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Duration</label>
                    <input type="text" id="symptomDuration" placeholder="e.g., 2 days, 1 week">
                </div>
                <button type="submit" class="btn btn-primary">Add Symptom</button>
            </form>
        </div>
    </div>

    <!-- Prescription Modal -->
    <div class="modal" id="prescriptionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Prescription</h3>
                <button class="close-modal" onclick="closeModal('prescriptionModal')">&times;</button>
            </div>
            <form id="prescriptionForm">
                <div class="form-group">
                    <label>Medication Name</label>
                    <input type="text" id="medicationName" placeholder="e.g., Amoxicillin" required>
                </div>
                <div class="form-group">
                    <label>Dosage</label>
                    <input type="text" id="dosage" placeholder="e.g., 500mg" required>
                </div>
                <div class="form-group">
                    <label>Frequency</label>
                    <input type="text" id="frequency" placeholder="e.g., 3 times daily" required>
                </div>
                <div class="form-group">
                    <label>Duration</label>
                    <input type="text" id="duration" placeholder="e.g., 7 days" required>
                </div>
                <div class="form-group">
                    <label>Instructions</label>
                    <textarea id="instructions" placeholder="Special instructions..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Prescription</button>
            </form>
        </div>
    </div>

    <script>
        let currentSessionId = null;

        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            if (tabName === 'history') {
                loadMedicalHistory();
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Form submissions
        document.getElementById('vitalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const vitalData = {
                blood_pressure_systolic: parseInt(document.getElementById('systolic').value) || null,
                blood_pressure_diastolic: parseInt(document.getElementById('diastolic').value) || null,
                heart_rate: parseInt(document.getElementById('heartRateInput').value) || null,
                temperature: parseFloat(document.getElementById('temperatureInput').value) || null,
                respiratory_rate: parseInt(document.getElementById('respiratoryRate').value) || null,
                oxygen_saturation: parseInt(document.getElementById('oxygenSatInput').value) || null
            };

            try {
                const response = await fetch(`/medical-sessions/${currentSessionId}/vital-signs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(vitalData)
                });

                if (response.ok) {
                    updateVitalSigns(vitalData);
                    closeModal('vitalModal');
                    document.getElementById('vitalForm').reset();
                }
            } catch (error) {
                console.error('Error adding vital signs:', error);
            }
        });

        document.getElementById('symptomForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const symptomData = {
                symptom_description: document.getElementById('symptomDescription').value,
                severity: document.getElementById('symptomSeverity').value,
                duration: document.getElementById('symptomDuration').value || null
            };

            try {
                const response = await fetch(`/medical-sessions/${currentSessionId}/symptoms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(symptomData)
                });

                if (response.ok) {
                    addSymptomToList(symptomData);
                    closeModal('symptomModal');
                    document.getElementById('symptomForm').reset();
                }
            } catch (error) {
                console.error('Error adding symptom:', error);
            }
        });

        document.getElementById('prescriptionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const prescriptionData = {
                medication_name: document.getElementById('medicationName').value,
                dosage: document.getElementById('dosage').value,
                frequency: document.getElementById('frequency').value,
                duration: document.getElementById('duration').value,
                instructions: document.getElementById('instructions').value || null
            };

            try {
                const response = await fetch(`/medical-sessions/${currentSessionId}/prescriptions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(prescriptionData)
                });

                if (response.ok) {
                    addPrescriptionToList(prescriptionData);
                    closeModal('prescriptionModal');
                    document.getElementById('prescriptionForm').reset();
                }
            } catch (error) {
                console.error('Error adding prescription:', error);
            }
        });

        function updateVitalSigns(vitals) {
            if (vitals.blood_pressure_systolic && vitals.blood_pressure_diastolic) {
                document.getElementById('bloodPressure').textContent = 
                    `${vitals.blood_pressure_systolic}/${vitals.blood_pressure_diastolic}`;
            }
            if (vitals.heart_rate) {
                document.getElementById('heartRate').textContent = `${vitals.heart_rate} bpm`;
            }
            if (vitals.temperature) {
                document.getElementById('temperature').textContent = `${vitals.temperature} °F`;
            }
            if (vitals.oxygen_saturation) {
                document.getElementById('oxygenSat').textContent = `${vitals.oxygen_saturation} %`;
            }
        }

        function addSymptomToList(symptom) {
            const list = document.getElementById('symptomsList');
            if (list.children[0].textContent === 'No symptoms recorded') {
                list.innerHTML = '';
            }
            
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `
                <strong>${symptom.symptom_description}</strong><br>
                Severity: ${symptom.severity} ${symptom.duration ? `| Duration: ${symptom.duration}` : ''}
            `;
            list.appendChild(item);
        }

        function addPrescriptionToList(prescription) {
            const list = document.getElementById('prescriptionsList');
            if (list.children[0].textContent === 'No prescriptions added') {
                list.innerHTML = '';
            }
            
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `
                <strong>${prescription.medication_name}</strong> ${prescription.dosage}<br>
                ${prescription.frequency} for ${prescription.duration}
                ${prescription.instructions ? `<br><em>${prescription.instructions}</em>` : ''}
            `;
            list.appendChild(item);
        }

        async function saveSession() {
            try {
                const sessionData = {
                    chief_complaint: document.getElementById('chiefComplaint').value,
                    session_notes: document.getElementById('sessionNotes').value
                };
                
                const response = await fetch(`/medical-sessions/${currentSessionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sessionData)
                });
                
                if (response.ok) {
                    alert('Session saved successfully!');
                } else {
                    throw new Error('Failed to save session');
                }
            } catch (error) {
                console.error('Error saving session:', error);
                alert('Failed to save session');
            }
        }

        function scheduleFollowUp() {
            alert('Follow-up scheduling feature coming soon!');
        }

        async function completeSession() {
            if (confirm('Are you sure you want to complete this session?')) {
                try {
                    // Save session first
                    await saveSession();
                    
                    // Complete the session
                    const response = await fetch(`/medical-sessions/${currentSessionId}/complete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        alert('Session completed successfully!');
                        window.location.href = 'doctor-dashboard.html';
                    } else {
                        throw new Error('Failed to complete session');
                    }
                } catch (error) {
                    console.error('Error completing session:', error);
                    alert('Failed to complete session');
                }
            }
        }

        async function loadMedicalHistory() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const appointmentId = urlParams.get('appointment');
                
                if (!appointmentId) {
                    document.getElementById('medicalHistory').innerHTML = '<p>No appointment ID provided</p>';
                    return;
                }
                
                // Get patient ID from current session
                const sessionResponse = await fetch(`/medical-sessions/${currentSessionId}`);
                if (!sessionResponse.ok) {
                    throw new Error('Failed to get session info');
                }
                
                const sessionData = await sessionResponse.json();
                const patientId = sessionData.patient_id;
                
                // Load patient medical history
                const historyResponse = await fetch(`/patient/${patientId}/medical-history`);
                if (historyResponse.ok) {
                    const history = await historyResponse.json();
                    
                    if (history.length === 0) {
                        document.getElementById('medicalHistory').innerHTML = '<p>No previous medical sessions found.</p>';
                        return;
                    }
                    
                    document.getElementById('medicalHistory').innerHTML = history.map(session => `
                        <div class="list-item">
                            <strong>${new Date(session.session_date).toLocaleDateString()} - ${session.doctor_name}</strong><br>
                            <strong>Chief Complaint:</strong> ${session.chief_complaint || 'Not recorded'}<br>
                            <strong>Status:</strong> ${session.status}<br>
                            ${session.diagnoses.length > 0 ? `<strong>Diagnoses:</strong> ${session.diagnoses.map(d => d.description).join(', ')}<br>` : ''}
                            ${session.prescriptions.length > 0 ? `<strong>Prescriptions:</strong> ${session.prescriptions.map(p => `${p.medication_name} ${p.dosage}`).join(', ')}<br>` : ''}
                            ${session.session_notes ? `<strong>Notes:</strong> ${session.session_notes}` : ''}
                        </div>
                    `).join('');
                } else {
                    document.getElementById('medicalHistory').innerHTML = '<p>Unable to load medical history.</p>';
                }
            } catch (error) {
                console.error('Error loading medical history:', error);
                document.getElementById('medicalHistory').innerHTML = '<p>Error loading medical history.</p>';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Get session ID from URL parameters or set default
            const urlParams = new URLSearchParams(window.location.search);
            currentSessionId = urlParams.get('session') || 1;
            
            // Load session data
            loadSessionData();
        });

        async function loadSessionData() {
            try {
                const response = await fetch(`/medical-sessions/${currentSessionId}`);
                if (response.ok) {
                    const sessionData = await response.json();
                    
                    // Update session info
                    document.getElementById('sessionId').textContent = `S${sessionData.session_id}`;
                    document.getElementById('patientName').textContent = sessionData.patient_name;
                    document.getElementById('patientId').textContent = `P${sessionData.patient_id}`;
                    document.getElementById('sessionStatus').textContent = sessionData.status;
                    
                    // Load existing data
                    if (sessionData.vital_signs.length > 0) {
                        const latest = sessionData.vital_signs[sessionData.vital_signs.length - 1];
                        updateVitalSigns({
                            blood_pressure_systolic: latest.blood_pressure ? latest.blood_pressure.split('/')[0] : null,
                            blood_pressure_diastolic: latest.blood_pressure ? latest.blood_pressure.split('/')[1] : null,
                            heart_rate: latest.heart_rate,
                            temperature: latest.temperature,
                            oxygen_saturation: latest.oxygen_saturation
                        });
                    }
                    
                    // Load symptoms
                    if (sessionData.symptoms.length > 0) {
                        const symptomsList = document.getElementById('symptomsList');
                        symptomsList.innerHTML = '';
                        sessionData.symptoms.forEach(symptom => {
                            addSymptomToList({
                                symptom_description: symptom.description,
                                severity: symptom.severity,
                                duration: symptom.duration
                            });
                        });
                    }
                    
                    // Load prescriptions
                    if (sessionData.prescriptions.length > 0) {
                        const prescriptionsList = document.getElementById('prescriptionsList');
                        prescriptionsList.innerHTML = '';
                        sessionData.prescriptions.forEach(prescription => {
                            addPrescriptionToList({
                                medication_name: prescription.medication_name,
                                dosage: prescription.dosage,
                                frequency: prescription.frequency,
                                duration: prescription.duration,
                                instructions: prescription.instructions
                            });
                        });
                    }
                    
                    // Load session notes
                    document.getElementById('chiefComplaint').value = sessionData.chief_complaint || '';
                    document.getElementById('sessionNotes').value = sessionData.session_notes || '';
                    
                } else {
                    console.error('Failed to load session data');
                    document.getElementById('sessionId').textContent = `S${currentSessionId}`;
                }
            } catch (error) {
                console.error('Error loading session data:', error);
                document.getElementById('sessionId').textContent = `S${currentSessionId}`;
            }
        }

        // Close modals when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
    </script>
</body>
</html>